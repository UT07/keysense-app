rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // ========================================================================
    // Helper Functions
    // ========================================================================

    function isAuthenticated() {
      return request.auth != null;
    }

    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }

    function isAdminUser() {
      return isAuthenticated() &&
             get(/databases/{database}/documents/admins/{request.auth.uid}).exists;
    }

    function isNotAnonymous() {
      return isAuthenticated() &&
             request.auth.token.firebase.sign_in_provider != 'anonymous';
    }

    // ========================================================================
    // User Profiles (users/{uid})
    // ========================================================================

    match /users/{userId} {
      // Owner reads own full profile; any authenticated user can read
      // public profile fields (displayName, selectedCatId) for friend requests
      allow read: if isAuthenticated();

      // Create profile on signup
      allow create: if isOwner(userId) &&
                      request.resource.data.uid == userId &&
                      request.resource.data.createdAt != null;

      // Update own profile
      allow update: if isOwner(userId) &&
                       request.resource.data.uid == userId;

      // Delete own profile
      allow delete: if isOwner(userId);

      // ====================================================================
      // Progress Sub-collection (users/{uid}/progress/{lessonId})
      // ====================================================================

      match /progress/{lessonId} {
        allow read: if isOwner(userId);
        allow create: if isOwner(userId) &&
                        request.resource.data.lessonId == lessonId;
        allow update: if isOwner(userId);
        // Allow deletion for account cleanup (via Cloud Functions)
        allow delete: if false;
      }

      // ====================================================================
      // Gamification Sub-collection (users/{uid}/gamification/{docId})
      // Explicit document IDs instead of wildcard
      // ====================================================================

      match /gamification/{docId} {
        allow read: if isOwner(userId);
        allow create, update: if isOwner(userId) &&
                                 docId in ['data', 'catEvolution', 'gems'];
        allow delete: if false;
      }

      // ====================================================================
      // XP Log Sub-collection (users/{uid}/xpLog/{doc})
      // ====================================================================

      match /xpLog/{logId} {
        allow read: if isOwner(userId);
        // Client cannot write — only Cloud Functions
        allow create, update, delete: if false;
      }

      // ====================================================================
      // Sync Log Sub-collection (users/{uid}/syncLog/{doc})
      // ====================================================================

      match /syncLog/{logId} {
        allow read: if isOwner(userId);
        allow create: if isOwner(userId);
        allow update: if isOwner(userId);
        allow delete: if false;
      }

      // ====================================================================
      // Settings Sub-collection (users/{uid}/settings/{doc})
      // ====================================================================

      match /settings/{settingId} {
        allow read: if isOwner(userId);
        allow create, update: if isOwner(userId);
        allow delete: if false;
      }

      // ====================================================================
      // Friends Sub-collection (users/{uid}/friends/{friendUid})
      // ====================================================================

      match /friends/{friendUid} {
        // Owner reads own friends list
        allow read: if isOwner(userId);
        // Any authenticated non-anonymous user can create friend connections
        // (needed for sendFriendRequest batch write — writes to BOTH users' subcollections)
        allow create: if isAuthenticated() && isNotAnonymous();
        // Owner manages (accept/update) own friend connections
        allow update: if isOwner(userId) && isNotAnonymous();
        // Any authenticated user can delete (needed for removeFriendConnection + account cleanup)
        allow delete: if isAuthenticated();
      }

      // ====================================================================
      // Activity Feed (users/{uid}/activity/{itemId})
      // ====================================================================

      match /activity/{itemId} {
        // Owner reads own feed; friends can post to it
        allow read: if isOwner(userId);
        // Any authenticated non-anonymous user can post (friend posts activity)
        allow create: if isAuthenticated() && isNotAnonymous();
        allow update, delete: if false;
      }

      // ====================================================================
      // Song Mastery (users/{uid}/songMastery/{songId})
      // ====================================================================

      match /songMastery/{songId} {
        allow read: if isOwner(userId);
        allow create, update: if isOwner(userId);
        allow delete: if false;
      }

      // ====================================================================
      // Song Requests / Rate Limiting (users/{uid}/songRequests/{date})
      // ====================================================================

      match /songRequests/{dateId} {
        allow read: if isOwner(userId);
        allow create, update: if isOwner(userId) &&
                                 request.resource.data.count is int &&
                                 request.resource.data.count <= 5;
        allow delete: if false;
      }
    }

    // ========================================================================
    // Songs Collection (songs/{songId}) — Public catalog
    // ========================================================================

    match /songs/{songId} {
      // All authenticated users can browse the song library
      allow read: if isAuthenticated();
      // Only admins can add/modify songs
      allow write: if isAdminUser();
    }

    // ========================================================================
    // Friend Codes (friendCodes/{code}) — Public lookup
    // ========================================================================

    match /friendCodes/{code} {
      // Any authenticated user can look up a friend code
      allow read: if isAuthenticated();
      // Owner can register their code (uid matches auth)
      allow create: if isAuthenticated() && isNotAnonymous() &&
                       request.resource.data.uid == request.auth.uid;
      // No updates from client
      allow update: if false;
      // Owner can delete their code (account cleanup)
      allow delete: if isAuthenticated() &&
                       resource.data.uid == request.auth.uid;
    }

    // ========================================================================
    // Challenges (challenges/{challengeId}) — Friend challenges
    // ========================================================================

    match /challenges/{challengeId} {
      // Participants can read
      allow read: if isAuthenticated() &&
                     (request.auth.uid == resource.data.fromUid ||
                      request.auth.uid == resource.data.toUid);
      // Authenticated non-anonymous users can create challenges
      allow create: if isAuthenticated() && isNotAnonymous() &&
                       request.resource.data.fromUid == request.auth.uid;
      // Participants can update (submit results)
      allow update: if isAuthenticated() &&
                       (request.auth.uid == resource.data.fromUid ||
                        request.auth.uid == resource.data.toUid);
      // Participants can delete (account cleanup)
      allow delete: if isAuthenticated() &&
                       (request.auth.uid == resource.data.fromUid ||
                        request.auth.uid == resource.data.toUid);
    }

    // ========================================================================
    // Leagues (leagues/{leagueId}) — Weekly competition groups
    // ========================================================================

    match /leagues/{leagueId} {
      // All authenticated users can read league info
      allow read: if isAuthenticated();
      // Authenticated non-anonymous users can create leagues (via assignToLeague transaction)
      allow create: if isAuthenticated() && isNotAnonymous() &&
                       request.resource.data.tier is string &&
                       request.resource.data.weekStart is string &&
                       request.resource.data.memberCount is int &&
                       request.resource.data.memberCount <= 30;
      // Allow updating memberCount (increment on join)
      allow update: if isAuthenticated() && isNotAnonymous() &&
                       request.resource.data.tier == resource.data.tier &&
                       request.resource.data.weekStart == resource.data.weekStart &&
                       request.resource.data.memberCount is int &&
                       request.resource.data.memberCount <= 30;
      allow delete: if false;

      // League Members (leagues/{leagueId}/members/{uid})
      match /members/{memberUid} {
        // All authenticated users can read standings
        allow read: if isAuthenticated();
        // Members can create their own entry (join) and update own XP
        allow create: if isOwner(memberUid) && isNotAnonymous();
        allow update: if isOwner(memberUid) &&
                         // Only allow updating weeklyXp via increment
                         request.resource.data.uid == resource.data.uid;
        allow delete: if false;
      }
    }

    // ========================================================================
    // Cache Collection (for AI responses and other cached data)
    // ========================================================================

    match /cache/{cacheType} {
      allow read: if isAuthenticated();
      // Only Cloud Functions can write to cache
      allow write: if false;

      match /{document=**} {
        allow read: if isAuthenticated();
        allow write: if false;
      }
    }

    // ========================================================================
    // Analytics Events (analytics/{event})
    // ========================================================================

    match /analytics/{document=**} {
      allow create: if isAuthenticated() &&
                       request.resource.data.userId == request.auth.uid &&
                       request.resource.data.timestamp != null;
      allow read: if isAdminUser();
      allow update, delete: if false;
    }

    // ========================================================================
    // Public Data (exercises, lessons - read-only for authenticated users)
    // ========================================================================

    match /exercises/{exerciseId} {
      allow read: if isAuthenticated();
      allow write: if isAdminUser();
    }

    match /lessons/{lessonId} {
      allow read: if isAuthenticated();
      allow write: if isAdminUser();
    }

    // ========================================================================
    // Admin Collection (admins/{uid})
    // ========================================================================

    match /admins/{userId} {
      allow read: if isOwner(userId);
      allow write: if false;
    }

    // ========================================================================
    // Default: Deny all other access
    // ========================================================================

    match /{document=**} {
      allow read, write: if false;
    }
  }
}
